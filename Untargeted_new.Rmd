---
title: 'Untargeted adenine coxs model and servival curve analysis'
author: Daniel Montemayor and Rabiul Islam<br><small>Center for Renal Precision Medicine<br>University
  of Texas Health San Antonio School of Medicine</small>
date: "<small>`r Sys.Date()`</small>"
output:
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: yes
    toc_float:
      collapsed: no
    code_folding: hide
    theme: cerulean
  pdf_document:
    toc: yes
    toc_depth: '3'
  word_document:
    toc: yes
    toc_depth: '3'
---

![Center for Renal Precision Medicine](https://dmontemayor.github.io/assets/Long_SOM/horizontal/JPG/UTHSA_Long-SOM_H_CMYK.jpg)

# Brief
+eGFR decline of 40% in each of the bins for the normo, micro, and normal+Micro goup
+ pertition by Adenine Tertiles for NA, MA, and NA+MA groups.

 ```{r}
knitr::opts_chunk$set(message = FALSE, warning=FALSE)
```
 
```{r requirements, message=FALSE, warning=FALSE}
#Requirements
requirements <- c("survival", "survminer","reshape","Hmisc","dplyr","reshape","ggplot2","caret","regclass","InformationValue","ISLR","lmtest","stats","epiDisplay","epicalc")
#CRAN repository
repos <- "http://cran.us.r-project.org"

#install and load missing requirements
for (pack in requirements){
  if( !is.element(pack, .packages(all.available = TRUE)) ) {
    #install.packages(pack, repos = repos)
    install.packages(pack)
  }
  library(pack, character.only = TRUE)
}
```

```{r constants}
rm(list=ls())
#Constants
MWade = 135.13 # molecular weights for adenine in g/mol
MWcre = 113.12 #molecular weights for creatinine in g/mol

#Random number seed
set.seed(10079)

```
# Load Redcap dataset 1
```{r download1}
#get data 1
dd <- read.csv("CRIC_clinical_creatinine_normalized_samplemetadata.csv", header = FALSE)
#get data 2
ad <- read.csv("adenine_creatinine_normalized.csv", header = FALSE)
ad<-melt(ad)
ac<-ad$value
dd$adenine<-ac
```


```{r}
id<-c()
adenine<-c()
# loop over the patients
for (i in 1:dim(dd)[1]){
  #Search over the patients to find baseline (V3Y0) patients id
  T<-sum(grepl("V3Y0",dd[i,]))
  if (T==0){
    
  }
  else{
    id<-c(id,dd[i,2])
    adenine<-c(adenine,dd[i,8])
  }
}
data<-as.data.frame(cbind(id,adenine))
```

```{r}
data$adenine<-as.numeric(data$adenine)
addata<-aggregate( adenine ~ id, data, mean)
addata$id <- gsub("*_V3Y0", "", addata$id)
names(addata)<-c("patientid","adenine")

boxplot(addata$adenine)
```

```{r}
Reddata <- read.csv("RedCap.csv")
rawdata<-merge(Reddata,addata,by="patientid")
```


```{r outcome40}
#select eGFR
egfrcols <- names(rawdata)[grep("egfr_cric_v", names(rawdata))]
#loop over years and count events for each year
for (year in 1:6){
  #print(year)
  #calculate 40% decline at each year
  t1 <- rawdata[, egfrcols[year+1]]  #EGFR[,year]
  t0 <- rawdata$egfr_cric_v3y0
  #t0 <- rawdata[, egfrcols[1]] #rawdata$egfr_cric_v3y0
  t2 <- rawdata$sa_allc_cric_renal2_v3y0
  
  #rawdata[paste("outcome40",year, sep = "_")] = (t2==1)
  #rawdata[paste("outcome40",year, sep = "_")] = ((t1-t0)/t0 < -.40) | (t2==1)
  rawdata[paste("outcome40",year, sep = "_")] =((t1-t0)/t0 < -.40) | ((t2==1) & year>= rawdata$sa_allc_cric_time_renal2_v3y0)
}
```


# Estimate outcome from year 1 to 6 together
```{r Normal_outcome_commulative}
#Extract time to events columns from rawdata
outcomes<-names(rawdata)[grep("outcome",names(rawdata))]
outcome<-c()
Etime<-c()
#Loop over patients
for (i in 1:dim(rawdata)[1]){
  #commulative outcomes from year 1 to 6
  outevent<-rawdata[outcomes[1:6]][i,]
  outcome[i]<-sum(outevent,na.rm=TRUE)
  Etime[i]<-6
  if (outcome[i]>0){
    Etime[i]<-which(rawdata[outcomes[1:6]][i,]==TRUE)[1]
  }
}
rawdata$outcome<-outcome>0
```

# Define event and time variable for cox model
```{r}
rawdata <- within(rawdata, {
    ## transplant (1) and death (2) are considered events, and marked 1
    event <- as.numeric(outcome)
    time<-Etime
    ## Create a survival vector
    surv <- Surv(time, event)
})
```

# Adenine preprocessing
```{r predictor}
impute<-function(x){
  replace(x, x==0, min(x[x>0], na.rm = TRUE)/2)
}
#predictor is log2 adenine
rawdata$predictor<- log2(impute(rawdata$adenine))
```


# Adenine and clinical Variable preprocessing to apply models 
```{r datapreprocessing}
#get ACR in units of mg/mmol (Dan)
rawdata$acr<-(rawdata$urine_albumin_v3y0/rawdata$urine_creatinine_v3y0)*1000/88.42
#Clinical varible normalization based on z-score
rawdata$age<-rawdata$age_integer_v3y0
rawdata$hemoglobin<-rawdata$hemoglobin_a1c_v3y0
rawdata$map<-rawdata$map_v3y0
rawdata$bmi<-rawdata$bmi_v3y0
rawdata$egfr<-rawdata$egfr_cric_v3y0
rawdata$logacr<-log(rawdata$acr)
```

# Display normal and micro group based on ACR
```{r partition}
#select normogroup
normopats <- rawdata$acr <3
micropats <- rawdata$acr >=3 & rawdata$acr <30
print(paste("number of patients with normo-albuminuria = ", sum(normopats, na.rm = TRUE)))
print(paste("number of patients with micro-albuminuria = ", sum(micropats, na.rm = TRUE)))
```

# get adenine normal and tertiles based on ACR group
```{r}
#select normal group patients from adenine (rawdata$predictor)
idx<-which(normopats)
#keep normal data
normalpatients<-rawdata[idx,]

quants<-quantile(rawdata$predictor[idx], na.rm=T, probs = seq(0,1, by=1/3))
print(paste("tertile cutoffs in (nm/um) for normal group= ", paste(quants, collapse=", ")))

T1patsnorm <- rawdata$predictor[idx] >= quants[1] & rawdata$predictor[idx] < quants[2]
T2patsnorm <- rawdata$predictor[idx] >= quants[2] & rawdata$predictor[idx] < quants[3]
T3patsnorm <- rawdata$predictor[idx] >= quants[3]
print(paste("Total number of patients on Normal group", sum(!is.na(rawdata$predictor[idx]))))

print(paste("number of patients in T1 ", sum(T1patsnorm, na.rm = TRUE)))
print(paste("number of patients in T2 ", sum(T2patsnorm, na.rm = TRUE)))
print(paste("number of patients in T3 ", sum(T3patsnorm, na.rm = TRUE)))
```
# Apply cox model to normal patients
```{r}
CPAD<-c("predictor","age","hemoglobin","map","bmi","egfr","logacr")

#Loop over tertile
data<-cbind(normalpatients["outcome"],normalpatients[CPAD],normalpatients["time"],normalpatients["event"])

#Id for tertile 1 and normal patients
idN<-which(T1patsnorm)
COVdataN1<-data[idN,]
modN1<-coxph(formula=Surv(COVdataN1$time, COVdataN1$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataN1)
modN1

#Id for tertile 2 and normal patients
idN<-which(T2patsnorm)
COVdataN2<-data[idN,]
modN2<-coxph(formula=Surv(COVdataN2$time, COVdataN2$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataN2)
modN2

#Id for tertile 3 and normal patients
idN<-which(T3patsnorm)
COVdataN3<-data[idN,]
modN3<-coxph(formula=Surv(COVdataN3$time, COVdataN3$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataN3)
modN3
```
# KM curve for Normal group
```{r NServivalCurve}
COVdataN1$quants<-"Q1"
COVdataN2$quants<-"Q2"
COVdataN3$quants<-"Q3"
#Q1 vs Q2
#subset_dataset<-rbind(COVdataN1,COVdataN2)

#Q3 vs Q3
#subset_dataset<-rbind(COVdataN2,COVdataN3)

subset_dataset<-rbind(COVdataN1,COVdataN2,COVdataN3)

ggsurvplot(survfit(Surv(subset_dataset$time, subset_dataset$event)~quants,data=subset_dataset),pval=TRUE)

normoData<-subset_dataset
```


# get adenine Micro and tertiles based on ACR group
```{r}
#select normal group patients from adenine (rawdata$predictor)
idx<-which(micropats)
#keep normal data
micropatients<-rawdata[idx,]

quants<-quantile(rawdata$predictor[idx], na.rm=T, probs = seq(0,1, by=1/3))
print(paste("tertile cutoffs in (nm/um) for micro group= ", paste(quants, collapse=", ")))

T1patsmicro <- rawdata$predictor[idx] >= quants[1] & rawdata$predictor[idx] < quants[2]
T2patsmicro <- rawdata$predictor[idx] >= quants[2] & rawdata$predictor[idx] < quants[3]
T3patsmicro <- rawdata$predictor[idx] >= quants[3]
print(paste("Total number of patients on micro group", sum(!is.na(rawdata$predictor[idx]))))

print(paste("number of patients in T1 ", sum(T1patsmicro, na.rm = TRUE)))
print(paste("number of patients in T2 ", sum(T2patsmicro, na.rm = TRUE)))
print(paste("number of patients in T3 ", sum(T3patsmicro, na.rm = TRUE)))
```

# Apply cox model to Micro patients
```{r}
CPAD<-c("predictor","age","hemoglobin","map","bmi","egfr","logacr")

#Loop over tertile
data<-cbind(micropatients["outcome"],micropatients[CPAD],micropatients["time"],micropatients["event"])

#Id for tertile 1 and micro patients
idN<-which(T1patsmicro)
COVdataM1<-data[idN,]
modM1<-coxph(formula=Surv(COVdataM1$time, COVdataM1$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataM1)
modM1

#Id for tertile 2 and micro patients
idN<-which(T2patsmicro)
COVdataM2<-data[idN,]
modM2<-coxph(formula=Surv(COVdataM2$time, COVdataM2$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataM2)
modM2

#Id for tertile 3 and micro patients
idN<-which(T3patsmicro)
COVdataM3<-data[idN,]
modM3<-coxph(formula=Surv(COVdataM3$time, COVdataM3$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataM3)
modM3
```

# KM curve for Micro group
```{r MServivalCurve}
COVdataM1$quants<-"Q1"
COVdataM2$quants<-"Q2"
COVdataM3$quants<-"Q3"
#Q1 vs Q2
#subset_dataset<-rbind(COVdataM1,COVdataM2)

#Q1 vs Q2 vs Q3
subset_dataset<-rbind(COVdataM1,COVdataM2,COVdataM3)

ggsurvplot(survfit(Surv(subset_dataset$time, subset_dataset$event)~quants,data=subset_dataset),pval=TRUE)

microData<-subset_dataset
```




# get adenine Normal+Micro and tertiles based on ACR group
```{r}
#select normal group patients from adenine (rawdata$predictor)
idx<-which(normopats | micropats)
#keep normal data
NMpatients<-rawdata[idx,]

quants<-quantile(rawdata$predictor[idx], na.rm=T, probs = seq(0,1, by=1/3))
print(paste("tertile cutoffs in (nm/um) for normal and micro group= ", paste(quants, collapse=", ")))

T1patsNM <- rawdata$predictor[idx] >= quants[1] & rawdata$predictor[idx] < quants[2]
T2patsNM <- rawdata$predictor[idx] >= quants[2] & rawdata$predictor[idx] < quants[3]
T3patsNM <- rawdata$predictor[idx] >= quants[3]
print(paste("Total number of patients on micro group", sum(!is.na(rawdata$predictor[idx]))))

print(paste("number of patients in T1 ", sum(T1patsNM, na.rm = TRUE)))
print(paste("number of patients in T2 ", sum(T2patsNM, na.rm = TRUE)))
print(paste("number of patients in T3 ", sum(T3patsNM, na.rm = TRUE)))
```


# Apply cox model to normal+micro patients
```{r}
CPAD<-c("predictor","age","hemoglobin","map","bmi","egfr","logacr")

#Loop over tertile
data<-cbind(NMpatients["outcome"],NMpatients[CPAD],NMpatients["time"],NMpatients["event"])

#Id for tertile 1 and micro patients
idN<-which(T1patsNM)
COVdataNM1<-data[idN,]
modNM1<-coxph(formula=Surv(COVdataNM1$time, COVdataNM1$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataNM1)
modNM1

#Id for tertile 2 and micro patients
idN<-which(T2patsNM)
COVdataNM2<-data[idN,]
modNM2<-coxph(formula=Surv(COVdataNM2$time, COVdataNM2$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataNM2)
modNM2

#Id for tertile 3 and micro patients
idN<-which(T3patsNM)
COVdataNM3<-data[idN,]
modNM3<-coxph(formula=Surv(COVdataNM3$time, COVdataNM3$event)~age+predictor+bmi+hemoglobin+map+egfr+logacr, data = COVdataNM3)
modNM3
```


# KM curve for Normal+Micro
```{r NMServivalCurve}
COVdataNM1$quants<-"Q1"
COVdataNM2$quants<-"Q2"
COVdataNM3$quants<-"Q3"
subset_dataset<-rbind(COVdataNM1,COVdataNM2,COVdataNM3)

ggsurvplot(survfit(Surv(subset_dataset$time, subset_dataset$event)~quants,data=subset_dataset),pval=TRUE)
NMData<-subset_dataset
```


```{r}
acr_group = c('normo', 'micro','MN')
sub_dataset<-list(normoData,microData,NMData)%>%
  set_names(acr_group)

adjusted_km_plots =acr_group%>%
  set_names() %>%
  map(function(nme) coxph(Surv(time, event)~age+strata(quants)+bmi+hemoglobin+map+egfr+logacr, data=sub_dataset[[nme]])%>%
        (function(x) ggadjustedcurves(x, data = sub_dataset[[nme]] %>%
                                        data.frame(),
                                      method = 'conditional')+labs(title = nme)))

```
